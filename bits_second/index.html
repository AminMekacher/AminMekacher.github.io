<!DOCTYPE html>
<html>

<head>

  <meta charset=utf-8 />
  <title>Bits Donation Network</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="src/sigma.min.js"></script>
  <script src="src/sigma.parsers.json.min.js"></script>

  <style>
    body {margin:0; padding:0;}
    #sigma-container {position:absolute; top:0; bottom:0; width:100%;}
	  
   /**
   * CAPTIONS PANELS:
   * ****************
   */
   .panel {
     background: white;
     padding: 1em;
     border-radius: 3px;
     box-shadow: 0 1px 5px #666;
     width: 300px;
     float: right;
   }
   .panel:not(:last-child) {
     margin-bottom: 0.5em;
   }
   .panel h2 button {
      float: right;
      background: white;
      border: 1px solid black;
      border-radius: 3px;
      font-size: 1.2em;
      height: 1em;
      width: 1em;
      text-align: center;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .panel h2 button:hover {
      opacity: 0.7;
    }
  </style>

</head>

<body>
  <div id="sigma-container"></div>

  <script>
  function init() {

    // Finds the connections of each node
    sigma.classes.graph.addMethod("neighbors", function(nodeId) {
      var k,
          neighbors = {},
          index = this.allNeighborsIndex[nodeId] || {};

      for (k in index)
        neighbors[k] = this.nodesIndex[k];

      return neighbors;
    });

   // Creates an instance of Sigma.js
    var sigInst = new sigma({
      renderers: [
        {
          container: document.getElementById("sigma-container"),
          type: "canvas"
        }
      ]
    });

    // Customizes its settings 
    sigInst.settings({
      // Drawing properties :
      defaultLabelColor: "#000",
      defaultLabelSize: 14,
      defaultLabelHoverColor: "#fff",
      labelThreshold: 11,
      defaultHoverLabelBGColor: "#888",
      defaultLabelBGColor: "#ddd",
      defaultEdgeType: "straight",

      // Graph properties :
      minNodeSize: 3,
      maxNodeSize: 10,
      minEdgeSize: 0.1,
      maxEdgeSize: 0.2,

      // Mouse properties :
      zoomMax: 20 
    });

    // Parses JSON file to fill the graph
    sigma.parsers.json(
      "data/senate.json",
      sigInst,
      function() {
		//  Little hack here:
		//  In the latest Sigma.js version have to delete edges" colors manually
        sigInst.graph.edges().forEach(function(e) {
          e.color = null;
        });

        // Also, to facilitate the update of node colors, store
        // their original color under the key originalColor:
        sigInst.graph.nodes().forEach(function(n) {
          n.originalColor = n.color;
        });

        sigInst.refresh();
      }
    );


     // When a node is clicked, check for each node to see if it is connected. If not, set its color as gray
     // Do the same for the edges

    var grayColor = "#ccc";
    sigInst.bind("overNode", function(e) {
      //console.log(e.type, e.data.node.label);
      var nodeId = e.data.node.id,
          toKeep = sigInst.graph.neighbors(nodeId);
      toKeep[nodeId] = e.data.node;

      sigInst.graph.nodes().forEach(function(n) {
        if (toKeep[n.id])
          n.color = n.originalColor;
        else
          n.color = grayColor;
      });

      sigInst.graph.edges().forEach(function(e) {
        if (e.source === nodeId || e.target === nodeId) {
          e.color = null;
	  e.size = e.size * 10;
	} else
          e.color = grayColor;
      });

    // Since the data has been modified,call the refresh method to make the colors update 
      sigInst.refresh();
    });

    // When a node is no longer being hovered over, return to original colors
    sigInst.bind("outNode", function(e) {
      //console.log(e.type, e.data.node.label);
      sigInst.graph.nodes().forEach(function(n) {
        n.color = n.originalColor;
      });

      sigInst.graph.edges().forEach(function(e) {
        e.color = null;
      });

      sigInst.refresh();
    });
	  
    sigInst.bind("clickNode", function(e) {
      console.log(e.type, e.data.node);
	    
      var info = document.createElement('div');
      info.className = "panel";
      info.id = 'attributes_popup';
	    
      if (document.contains(document.getElementById("attributes_popup"))) {
      	document.getElementById("attributes_popup").remove();
      }   else {
        document.getElementsByTagName('body')[0].appendChild(info);
      }
	  
      document.getElementsByTagName('body')[0].appendChild(info);
	
      // Add text inside the window
      var para = document.createElement("h2");
      var node = document.createTextNode(e.data.node.label);
      para.appendChild(node);
      info.appendChild(para);

      // Add the degree to the panel
      var degree = document.createElement("p");
      var deg_text = document.createTextNode("Degree: " + e.data.node.attributes['Degree']);
      degree.appendChild(deg_text);
      info.appendChild(degree);
	
      // Add the community to the panel
      var community = document.createElement("p");
      var com_text = document.createTextNode("Community: " + e.data.node.attributes['Modularity Class']);
      community.appendChild(com_text);
      info.appendChild(community);
	    
      // Add the betweenness centrality to the panel
      var betweennness = document.createElement("p");
      var betw_text = document.createTextNode("Betweenness Centrality: " + e.data.node.attributes['Betweenness Centrality']);
      betweennness.appendChild(betw_text);
      info.appendChild(betweennness);
	    
      // Add the PageRank to the panel
      var pagerank = document.createElement("p");
      var pr_text = document.createTextNode("PageRank: " + e.data.node.attributes['PageRank']);
      pagerank.appendChild(pr_text);
      info.appendChild(pagerank);
	    
      sigInst.refresh();
    });
  }

  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", init, false);
  else
    window.onload = init;
  </script>

</body>

</html>
